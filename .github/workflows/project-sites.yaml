name: Project Sites CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'apps/project-sites/**'
      - 'packages/shared/**'
      - 'supabase/**'
      - '.github/workflows/project-sites.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/project-sites/**'
      - 'packages/shared/**'
      - 'supabase/**'
      - '.github/workflows/project-sites.yaml'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PNPM_VERSION: 9.14.4
  NODE_VERSION: 20

jobs:
  # ============================================================================
  # LINT & TYPECHECK
  # ============================================================================
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @project-sites/shared build

      - name: Lint shared package
        run: pnpm --filter @project-sites/shared lint

      - name: Typecheck shared package
        run: pnpm --filter @project-sites/shared typecheck

      - name: Typecheck worker
        run: pnpm --filter @project-sites/worker typecheck

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run shared package tests
        run: pnpm --filter @project-sites/shared test --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: packages/shared/coverage/lcov.info
          flags: shared
          fail_ci_if_error: false

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @project-sites/shared build

      - name: Run worker integration tests
        run: pnpm --filter @project-sites/worker test:integration
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_TEST }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY_TEST }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY_TEST }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET_TEST }}

  # ============================================================================
  # BUILD
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @project-sites/shared build

      - name: Build bolt.diy
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: |
            build/
            packages/shared/dist/
          retention-days: 1

  # ============================================================================
  # DEPLOY STAGING
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, test-integration]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build

      - name: Deploy Worker to Staging
        run: pnpm --filter @project-sites/worker deploy:staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy bolt.diy to Staging (Pages)
        run: npx wrangler pages deploy build/client --project-name=bolt-staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # ============================================================================
  # E2E TESTS (POST-DEPLOY)
  # ============================================================================
  test-e2e-staging:
    name: E2E Tests (Staging)
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Cypress
        run: npx cypress install

      - name: Run E2E tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          record: false
        env:
          CYPRESS_BASE_URL: https://staging.sites.megabyte.space
          CYPRESS_BOLT_URL: https://bolt-staging.pages.dev

      - name: Upload E2E screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots

  # ============================================================================
  # DEPLOY PRODUCTION
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test-e2e-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build

      - name: Deploy Worker to Production
        id: deploy-worker
        run: pnpm --filter @project-sites/worker deploy:production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy bolt.diy to Production (Pages)
        id: deploy-pages
        run: npx wrangler pages deploy build/client --project-name=bolt --branch=main
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # ============================================================================
  # POST-DEPLOY SMOKE TESTS
  # ============================================================================
  smoke-test-production:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Health check - sites.megabyte.space
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://sites.megabyte.space/health)
          if [ "$response" != "200" ]; then
            echo "Health check failed with status $response"
            exit 1
          fi
          echo "Health check passed"

      - name: Health check - bolt.megabyte.space
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://bolt.megabyte.space)
          if [ "$response" != "200" ]; then
            echo "Health check failed with status $response"
            exit 1
          fi
          echo "Health check passed"

      - name: Run smoke test suite
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          spec: cypress/e2e/smoke/**/*.cy.ts
          record: false
        env:
          CYPRESS_BASE_URL: https://sites.megabyte.space
          CYPRESS_BOLT_URL: https://bolt.megabyte.space

  # ============================================================================
  # ROLLBACK ON FAILURE
  # ============================================================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: smoke-test-production
    if: failure()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Rollback Worker
        run: |
          echo "Rolling back worker to previous deployment..."
          # Get previous deployment
          PREV_DEPLOYMENT=$(npx wrangler deployments list --json | jq -r '.[1].id')
          if [ -n "$PREV_DEPLOYMENT" ]; then
            npx wrangler rollback $PREV_DEPLOYMENT
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Notify failure
        run: |
          echo "Deployment failed and was rolled back!"
          # Add Slack/Discord notification here
